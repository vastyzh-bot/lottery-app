<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ä¸œåŒ—å¤§å­¦å·¥å•†ç®¡ç†å­¦é™¢å…ƒæ—¦æ™šä¼šæŠ½å¥–ï¼ˆæ‰¹é‡æŠ½å–ï¼‰</title>
    <style>
        :root {
            /* å–œåº†é…è‰² */
            --theme-red-dark: #8e0e00;
            --theme-red-light: #d90429;
            --theme-gold: #ffd700;
            --theme-gold-warm: #ffb300;
            --text-light: #fff0f3;
            /* ä¸œåŒ—å¤§å­¦æ ¡è‰²ï¼šè“ (#00418A) - ç°å·²æ”¹ä¸ºä½¿ç”¨äº®è‰² */
            --neuedu-blue: #00418A;
        }

        /* --- KEYFRAMES åŠ¨ç”»å®šä¹‰ --- */

        /* 1. èƒŒæ™¯æ…¢é€ŸåŠ¨æ€ç§»åŠ¨ */
        @keyframes dynamic-bg {
            0% { background-position: 0% 0%; }
            100% { background-position: 100% 100%; }
        }

        /* 2. æ ‡é¢˜å‘¼å¸å…‰æ™• */
        @keyframes title-glow {
            0% { text-shadow: 0 0 10px var(--theme-gold); }
            50% { text-shadow: 0 0 25px var(--theme-gold), 0 0 5px rgba(255, 50, 0, 0.5); }
            100% { text-shadow: 0 0 10px var(--theme-gold); }
        }

        /* 3. ä¸‰ç­‰å¥– (3rd): æ ‡å‡†è„‰å†²ï¼Œ500ms */
        @keyframes pulse-gold-3rd {
            0% { transform: scale(1.2); box-shadow: 0 0 10px var(--theme-gold); }
            50% { transform: scale(1.4); box-shadow: 0 0 30px 10px rgba(255, 215, 0, 0.7); }
            100% { transform: scale(1); box-shadow: 0 0 20px rgba(255, 215, 0, 0.6); }
        }

        /* 4. äºŒç­‰å¥– (2nd): æ›´å¤§è„‰å†²ï¼Œ700msï¼Œæ›´äº® */
        @keyframes pulse-gold-2nd {
            0% { transform: scale(1.3); box-shadow: 0 0 15px var(--theme-gold); }
            50% { 
                transform: scale(1.7); /* æ›´å¤§çš„æ”¾å¤§æ•ˆæœ */
                box-shadow: 0 0 60px 25px rgba(255, 215, 0, 0.9), 0 0 40px 15px rgba(255, 50, 0, 0.7); /* å¼ºå…‰æ™• */
            }
            100% { transform: scale(1); box-shadow: 0 0 20px rgba(255, 215, 0, 0.6); }
        }

        /* 5. ä¸€ç­‰å¥– (1st): æœ€ç‚¸è£‚ï¼Œ1000msï¼Œçˆ†ç‚¸æ€§å…‰æ™• */
        @keyframes pulse-gold-1st {
            0% { 
                transform: scale(1.4);
                box-shadow: 0 0 20px var(--theme-gold);
            }
            50% { 
                transform: scale(2.0); /* çˆ†ç‚¸æ€§æ”¾å¤§ */
                box-shadow: 0 0 100px 40px rgba(255, 255, 200, 1), 0 0 50px 20px rgba(255, 50, 0, 1); /* æè‡´å…‰æ™• */
            }
            100% { 
                transform: scale(1);
                box-shadow: 0 0 20px rgba(255, 215, 0, 0.6);
            }
        }
        
        /* 6. ä¸»é¢˜æ–‡å­—/å¤§å­¦åç§°å‘¼å¸æ•ˆæœ */
        @keyframes theme-pulse {
            0% { opacity: 0.8; transform: scale(1.0); }
            100% { opacity: 1.0; transform: scale(1.02); }
        }

        /* --- åŸºç¡€æ ·å¼å’Œå¸ƒå±€ --- */

        body {
            font-family: 'Microsoft YaHei', sans-serif;
            /* åŠ¨æ€èƒŒæ™¯é…ç½® */
            background: radial-gradient(circle at 50% 30%, #e63946 0%, #8e0e00 70%, #2c0400 100%);
            background-size: 200% 200%; /* ä½¿èƒŒæ™¯å¤§äºè§†å£ï¼Œä»¥ä¾¿ç§»åŠ¨ */
            animation: dynamic-bg 60s linear infinite alternate; /* æ…¢é€Ÿã€æ— é™ã€äº¤æ›¿è¿åŠ¨ */
            
            color: var(--text-light);
            margin: 0;
            height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
            overflow: hidden;
            position: relative; 
        }

        /* ç²’å­ç”»å¸ƒï¼Œä½œä¸ºåº•å±‚ç‰¹æ•ˆ */
        #particleCanvas {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 1; 
            pointer-events: none; 
        }

        header {
            margin-top: 20px;
            text-align: center;
            border-bottom: 2px solid rgba(255, 215, 0, 0.3);
            padding-bottom: 10px;
            width: 80%;
            z-index: 10;
        }
        
        /* --- ä¸œåŒ—å¤§å­¦æ ‡é¢˜æ ·å¼ (é¢œè‰²è°ƒæ•´ä¸ºäº®è‰²) --- */
        #university-title {
            font-size: 2.2rem;
            margin-bottom: 5px;
            color: var(--text-light); /* äº®ç™½è‰²/æš–é‡‘è‰² */
            font-family: 'SimHei', 'Heiti SC', sans-serif; /* ç²—é»‘ä½“ï¼Œåº„é‡ */
            font-weight: bold;
            letter-spacing: 10px;
            /* è°ƒæ•´ä¸ºé‡‘çº¢å…‰æ™•ï¼Œå¹¶ä½¿ç”¨ä¸»é¢˜å‘¼å¸åŠ¨ç”» */
            text-shadow: 0 0 10px var(--theme-gold), 0 0 5px var(--theme-red-light);
            animation: theme-pulse 4s ease-in-out infinite alternate;
        }


        h1 {
            font-size: 3rem;
            margin: 0;
            color: var(--theme-gold);
            text-shadow: 0 0 15px rgba(255, 215, 0, 0.8), 2px 2px 5px rgba(0,0,0,0.6);
            letter-spacing: 3px;
            font-weight: 800;
            animation: title-glow 3s ease-in-out infinite alternate; /* æ ‡é¢˜å‘¼å¸å…‰æ•ˆ */
        }
        
        /* --- æ™šä¼šä¸»é¢˜æ ·å¼ (å­—ä½“å·²åŠ å¤§) --- */
        #main-theme {
            font-size: 2.2rem; 
            margin-top: 10px;
            color: var(--text-light);
            /* ä½¿ç”¨ç²—çŠ·çš„è¡¬çº¿å­—ä½“ï¼Œæ¨¡æ‹Ÿä¹¦æ³•æ„Ÿ */
            font-family: 'SimSun', 'STKaiTi', 'KaiTi', serif; 
            font-weight: 900; /* æç²—ä½“ */
            letter-spacing: 8px; /* å¢åŠ å­—é—´è· */
            padding: 5px 15px;
            border: 1px solid rgba(255, 255, 255, 0.3);
            border-radius: 10px;
            background: rgba(142, 14, 0, 0.4); /* åŠé€æ˜çº¢è‰²èƒŒæ™¯ */
            
            /* å‘¼å¸å…‰æ™•æ•ˆæœï¼šé‡‘çº¢åŒè‰²å…‰æ™• */
            text-shadow: 
                0 0 8px var(--theme-gold), /* å¢å¤§å…‰æ™•æ•ˆæœ */
                0 0 20px var(--theme-red-light);
            
            animation: theme-pulse 2s ease-in-out infinite alternate;
        }

        /* æ§åˆ¶é¢æ¿ */
        .controls {
            margin-top: 20px;
            display: flex;
            gap: 15px;
            z-index: 10;
        }

        .btn {
            padding: 10px 25px;
            font-size: 1.1rem;
            border: none;
            border-radius: 50px;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 6px 15px rgba(0,0,0,0.4);
            font-weight: bold;
        }

        .btn-prize {
            background: rgba(142, 14, 0, 0.6);
            color: var(--theme-gold);
            border: 2px solid var(--theme-gold-warm);
        }

        .btn-prize.active {
            background: linear-gradient(to bottom, var(--theme-gold), var(--theme-gold-warm));
            color: var(--theme-red-dark);
            box-shadow: 0 0 20px var(--theme-gold);
            transform: scale(1.05);
        }

        /* æ ¸å¿ƒæ“ä½œæŒ‰é’® */
        .btn-action {
            background: linear-gradient(to bottom, #ff4d5a, #d90429);
            color: white;
            min-width: 250px; /* å¢åŠ å®½åº¦ä»¥å®¹çº³æ›´é•¿çš„æ–‡æœ¬ */
            border: 2px solid #ff7b85;
            font-size: 1.3rem;
        }
        /* å¢åŠ æŒ‰é’®æŒ‰ä¸‹æ—¶çš„æ·±åº¦æ•ˆæœ */
        .btn-action:active {
            transform: translateY(2px);
            box-shadow: 0 3px 10px rgba(0,0,0,0.4);
        }

        .btn-action:disabled {
            background: #555;
            border-color: #777;
            cursor: not-allowed;
            transform: none;
        }

        .btn-reset {
            background: transparent;
            color: rgba(255,255,255,0.6);
            border: 1px solid rgba(255,255,255,0.3);
            font-size: 0.9rem;
        }
        .btn-reset.danger {
            color: #ffcccc;
            border-color: #d90429;
        }


        /* æŠ½å¥–å±•ç¤ºåŒº */
        #display-area {
            flex-grow: 1;
            width: 90%;
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            align-content: center;
            gap: 30px;
            padding: 20px;
            z-index: 10;
        }

        /* å¥–çƒæ ·å¼ */
        .ball {
            width: 100px;
            height: 100px;
            background: radial-gradient(circle at 30% 30%, #e0e0e0, #a0a0a0);
            border-radius: 50%;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 2.5rem;
            color: #555;
            font-weight: 900;
            border: 4px solid #ccc;
            box-shadow: inset -5px -5px 10px rgba(0,0,0,0.3), 0 10px 20px rgba(0,0,0,0.5);
            position: relative;
            transition: all 0.3s;
            opacity: 0.8; /* é»˜è®¤ç•¥é€æ˜ */
        }
        
        /* æ­£åœ¨æŠ½å–çš„å½“å‰çƒï¼ˆç°åœ¨æ˜¯æ‰€æœ‰æœªä¸­å¥–çƒï¼‰ */
        .ball:not(.won) {
            opacity: 0.6;
        }

        /* å·²ä¸­å¥–çš„çƒï¼ˆé‡‘è›‹ï¼‰ - ç¡®ä¿é«˜å¯¹æ¯”åº¦ */
        .ball.won {
            opacity: 1;
            background: radial-gradient(circle at 30% 30%, #fffbdb, #ffd700 40%, #ff8c00 100%);
            color: #000; /* ä¿®æ”¹ä¸ºçº¯é»‘è‰²ï¼Œç¡®ä¿å¯è§æ€§ */
            border-color: #ffd700;
            box-shadow: 
                inset -5px -5px 15px rgba(142, 14, 0, 0.3),
                0 0 20px rgba(255, 215, 0, 0.6);
            cursor: pointer;
        }

        .ball.won:hover::after {
            content: "ç‚¹å‡»é‡æŠ½";
            position: absolute;
            bottom: -30px;
            font-size: 14px;
            background: rgba(0,0,0,0.8);
            color: #fff;
            padding: 2px 6px;
            border-radius: 4px;
            white-space: nowrap;
        }

        /* æ»šåŠ¨æ—¶çš„æ ·å¼ */
        .ball.rolling {
            background: radial-gradient(circle at 30% 30%, #fff, #ffcccb);
            color: #d90429;
            border-color: #d90429;
            opacity: 1; /* æ»šåŠ¨æ—¶é«˜äº® */
            /* å¢åŠ ä¸€ç‚¹æ»šåŠ¨æ—¶çš„è·³åŠ¨æ„Ÿ */
            transform: scale(1.1) rotate(0deg);
            transition: transform 0.1s;
        }

        .status-bar {
            margin-bottom: 15px;
            font-size: 1rem;
            color: var(--theme-gold);
            opacity: 0.8;
            z-index: 10;
        }

        @keyframes shake {
            0% { transform: scale(1.1) rotate(0deg); }
            25% { transform: scale(1.1) rotate(-5deg); }
            50% { transform: scale(1.1) rotate(5deg); }
            75% { transform: scale(1.1) rotate(-5deg); }
            100% { transform: scale(1.1) rotate(0deg); }
        }
        .shaking { animation: shake 0.5s infinite; }

        /* --- åŠ¨ç”»åº”ç”¨ï¼šæ ¹æ®å¥–é¡¹çº§åˆ«åŒºåˆ†ç‰¹æ•ˆ --- */

        /* ä¸‰ç­‰å¥–åŠ¨ç”»åº”ç”¨ */
        .ball.won.reveal.pulse-gold-3rd {
            animation: pulse-gold-3rd 0.5s ease-out 1;
        }

        /* äºŒç­‰å¥–åŠ¨ç”»åº”ç”¨ */
        .ball.won.reveal.pulse-gold-2nd {
            animation: pulse-gold-2nd 0.7s ease-out 1; 
        }

        /* ä¸€ç­‰å¥–åŠ¨ç”»åº”ç”¨ (æœ€ç‚«é…·) */
        .ball.won.reveal.pulse-gold-1st {
            animation: pulse-gold-1st 1.0s ease-out 1; 
        }
    </style>
</head>
<body>
    <!-- ç²’å­ç‰¹æ•ˆç”»å¸ƒ -->
    <canvas id="particleCanvas"></canvas>

    <header>
        <!-- æ–°å¢ï¼šä¸œåŒ—å¤§å­¦æ ‡é¢˜ -->
        <div id="university-title">ä¸œåŒ—å¤§å­¦</div>
        <h1>ğŸ‰ å·¥å•†ç®¡ç†å­¦é™¢å…ƒæ—¦æ™šä¼š ğŸ‰</h1>
        <!-- æ–°å¢/ä¿®æ”¹ï¼šæ™šä¼šä¸»é¢˜ (å­—ä½“å·²åŠ å¤§) -->
        <div id="main-theme">ä¹ç§©æ‰¿è–ªç«ï¼Œé©°æ¢¦å¯æ–°å…ƒ</div> 
    </header>

    <div class="controls">
        <button class="btn btn-prize" onclick="setPrize('3rd', 15, this)">ä¸‰ç­‰å¥– (15äºº)</button>
        <button class="btn btn-prize" onclick="setPrize('2nd', 10, this)">äºŒç­‰å¥– (10äºº)</button>
        <button class="btn btn-prize" onclick="setPrize('1st', 5, this)">ä¸€ç­‰å¥– (5äºº)</button>
    </div>

    <div class="controls">
        <!-- ä¸»æ“ä½œæŒ‰é’®ï¼šæ§åˆ¶æ»šåŠ¨å’Œæ‰¹é‡æŠ½å– -->
        <button id="actionBtn" class="btn btn-action" onclick="toggleDraw()">è¯·å…ˆé€‰æ‹©å¥–é¡¹ (æŒ‰ç©ºæ ¼)</button> 
        <button class="btn btn-reset danger" onclick="resetAllData()">ğŸ’¥ å½»åº•æ¸…ç©ºæ•°æ®</button>
    </div>

    <div class="status-bar" id="status-text">æ•°æ®åŠ è½½ä¸­...</div>

    <div id="display-area"></div>

    <script>
        // --- å­˜å‚¨ Key å®šä¹‰ ---
        const LS_KEY_NUMBERS = 'lottery_available_numbers';
        const LS_KEY_RECORDS = 'lottery_prize_records';

        // --- å…¨å±€é…ç½®æ•°æ® ---
        const TOTAL_PEOPLE = 600;
        let availableNumbers = []; // å‰©ä½™å·ç æ± 
        let currentPrizeId = null; // å½“å‰æ­£åœ¨æ“ä½œçš„å¥–é¡¹ID (e.g., '3rd')
        let currentPrizeTotal = 0; // å½“å‰å¥–é¡¹æ€»åé¢
        let isRolling = false; // æ˜¯å¦å¤„äºæ»šåŠ¨çŠ¶æ€
        let rollInterval = null; // ç”¨äºå­˜å‚¨è®¡æ—¶å™¨ID
        let rollingBalls = []; // å­˜å‚¨æ­£åœ¨æ»šåŠ¨çš„DOMå…ƒç´ 

        // åˆå§‹ä¸­å¥–è®°å½•ç»“æ„
        let prizeRecords = {
            '3rd': [],
            '2nd': [],
            '1st': []
        };

        // --- é”®ç›˜äº‹ä»¶ç›‘å¬ ---
        document.addEventListener('keydown', function(event) {
            // æ£€æŸ¥æ˜¯å¦æ˜¯ç©ºæ ¼é”® (key code 32 for spacebar, or modern event.code 'Space')
            if (event.code === 'Space' || event.keyCode === 32) {
                // é˜»æ­¢é»˜è®¤çš„ç©ºæ ¼é”®è¡Œä¸ºï¼ˆå¦‚é¡µé¢æ»šåŠ¨ï¼‰
                event.preventDefault(); 
                // åªæœ‰åœ¨æŒ‰é’®ä¸æ˜¯ disabled çš„æƒ…å†µä¸‹æ‰è§¦å‘æŠ½å¥–
                const actionBtn = document.getElementById('actionBtn');
                if (!actionBtn.disabled) {
                    toggleDraw();
                }
            }
        });

        // --- æ•°æ®å­˜å‚¨/åŠ è½½å‡½æ•° ---

        // ä¿å­˜æ•°æ®åˆ° localStorage
        function saveData() {
            try {
                localStorage.setItem(LS_KEY_NUMBERS, JSON.stringify(availableNumbers));
                localStorage.setItem(LS_KEY_RECORDS, JSON.stringify(prizeRecords));
            } catch (e) {
                console.error("æ— æ³•ä¿å­˜æ•°æ®åˆ°æœ¬åœ°å­˜å‚¨:", e);
                document.getElementById('status-text').textContent = "è­¦å‘Šï¼šæµè§ˆå™¨å­˜å‚¨å—é™ï¼Œæ•°æ®å¯èƒ½æ— æ³•ä¿å­˜ï¼";
            }
        }

        // ä» localStorage åŠ è½½æ•°æ®
        function loadData() {
            const savedNumbers = localStorage.getItem(LS_KEY_NUMBERS);
            const savedRecords = localStorage.getItem(LS_KEY_RECORDS);

            if (savedNumbers && savedRecords) {
                // åŠ è½½å†å²æ•°æ®
                availableNumbers = JSON.parse(savedNumbers);
                prizeRecords = JSON.parse(savedRecords);
                console.log("æ•°æ®å·²ä»æœ¬åœ°å­˜å‚¨åŠ è½½ï¼Œå½“å‰å‰©ä½™äººæ•°:", availableNumbers.length);
                updateStatus("æ•°æ®å·²æ¢å¤ (ä¸Šæ¬¡è¿›åº¦)");
            } else {
                // åˆå§‹åŒ–æ–°æ•°æ®
                initPool();
                updateStatus("ç³»ç»Ÿå·²åˆå§‹åŒ–");
            }
            document.getElementById('actionBtn').disabled = true;

            // ç¡®ä¿ç²’å­åŠ¨ç”»åœ¨æ•°æ®åŠ è½½åå¯åŠ¨
            animateParticles(); 
        }

        // é¡µé¢åŠ è½½æ—¶è°ƒç”¨ loadData
        window.onload = loadData;

        // åˆå§‹åŒ–å·ç æ±  (ä»…åœ¨æ— å†å²æ•°æ®æ—¶è°ƒç”¨)
        function initPool() {
            availableNumbers = [];
            for (let i = 1; i <= TOTAL_PEOPLE; i++) {
                availableNumbers.push(i);
            }
            // é‡ç½®è®°å½•
            prizeRecords = {'3rd': [], '2nd': [], '1st': []};
            saveData(); // ç«‹å³ä¿å­˜åˆå§‹åŒ–çŠ¶æ€
        }

        // --- åˆ‡æ¢å¥–é¡¹ ---
        function setPrize(prizeId, count, clickedButton) {
            if (isRolling) return; 
            
            // ç¡®ä¿ clickedButton æ˜¯ä¸€ä¸ªæœ‰æ•ˆçš„ DOM å…ƒç´ 
            
            currentPrizeId = prizeId;
            currentPrizeTotal = count;
            
            // æŒ‰é’®æ ·å¼æ›´æ–°
            document.querySelectorAll('.btn-prize').forEach(btn => btn.classList.remove('active'));
            if (clickedButton) {
                clickedButton.classList.add('active');
            }
            
            const records = prizeRecords[prizeId];
            const display = document.getElementById('display-area');
            display.innerHTML = ''; // æ¸…ç©ºæ˜¾ç¤ºåŒº

            let currentDrawnCount = records.length; 

            // 1. æ¸²æŸ“å·²ä¸­å¥–åå• (å¦‚æœæœ‰)
            records.forEach((num, index) => {
                const ball = createBall(num, `ball-${index}`, true);
                display.appendChild(ball);
            });

            // 2. æ¸²æŸ“å‰©ä½™çš„å ä½ç¬¦ (å¦‚æœæœ‰)
            for(let i = currentDrawnCount; i < currentPrizeTotal; i++) {
                const ball = createBall('?', `ball-${i}`, false);
                display.appendChild(ball);
            }

            // æ›´æ–°ä¸»æŒ‰é’®çŠ¶æ€å’Œæ ·å¼
            updateActionButton(currentDrawnCount);
            
            updateStatus(`å½“å‰å¥–é¡¹ï¼š${getLevelName(prizeId)}`);
        }
        
        // --- è¾…åŠ©å‡½æ•°ï¼šåˆ›å»ºå¥–çƒDOMå…ƒç´  ---
        function createBall(content, id, isWon) {
            let ball = document.createElement('div');
            ball.className = isWon ? 'ball won' : 'ball';
            ball.id = id;
            ball.textContent = content;
            if (isWon) {
                ball.onclick = function() { redrawOne(this); };
            }
            return ball;
        }

        // --- æ›´æ–°æ“ä½œæŒ‰é’®æ–‡å­—å’ŒçŠ¶æ€ (å·²é€‚é…æ‰¹é‡æŠ½å–é€»è¾‘) ---
        function updateActionButton(drawnCount) {
            const btn = document.getElementById('actionBtn');
            const remaining = currentPrizeTotal - drawnCount;

            btn.disabled = false;
            // æ¢å¤é»˜è®¤çš„è¡ŒåŠ¨æŒ‰é’®æ ·å¼
            btn.className = 'btn btn-action'; 
            btn.style.background = ''; // æ¸…é™¤å†…è” background æ ·å¼
            btn.style.color = ''; // æ¸…é™¤å†…è” color æ ·å¼

            if (remaining > 0) {
                if (isRolling) {
                    btn.textContent = `åœ æ­¢ & æ‰¹é‡æŠ½å– ${remaining} äºº (æŒ‰ç©ºæ ¼)`;
                    // æ»šåŠ¨çŠ¶æ€ä¸‹çš„é«˜äº®é¢œè‰²
                    btn.style.background = "#ffb300"; 
                    btn.style.color = "#8e0e00";
                } else {
                    btn.textContent = `å¼€å§‹æ»šåŠ¨ / æ‰¹é‡æŠ½å– ${remaining} äºº (æŒ‰ç©ºæ ¼)`;
                }
            } else {
                btn.textContent = `${getLevelName(currentPrizeId)} å·²å…¨éƒ¨æŠ½å‡º (${currentPrizeTotal}äºº)`;
                btn.disabled = true;
                btn.style.background = "#555"; // ç¦ç”¨æ—¶çš„é¢œè‰²
            }
        }

        // --- æ ¸å¿ƒæ‰¹é‡æŠ½å¥–é€»è¾‘ï¼ˆå¼€å§‹æ»šåŠ¨æˆ–åœæ­¢æŠ½å–ï¼‰ ---
        function toggleDraw() {
            if (!currentPrizeId) {
                const status = document.getElementById('status-text');
                // ä¿®å¤ï¼šæ·»åŠ å­—ç¬¦ä¸²å¼•å·
                status.textContent = "âš ï¸ è¯·å…ˆé€‰æ‹©è¦æŠ½å–çš„å¥–é¡¹ï¼";
                setTimeout(() => updateStatus(), 1500);
                return;
            }

            const drawnCount = prizeRecords[currentPrizeId].length;
            const remainingToDraw = currentPrizeTotal - drawnCount;

            if (remainingToDraw <= 0 || availableNumbers.length === 0) {
                updateActionButton(drawnCount);
                return;
            }

            const display = document.getElementById('display-area');

            if (!isRolling) {
                // --> 1. å¼€å§‹æ‰€æœ‰å‰©ä½™çƒçš„æ»šåŠ¨åŠ¨ç”»
                isRolling = true;
                rollingBalls = display.querySelectorAll('.ball:not(.won)');
                updateActionButton(drawnCount); // æ›´æ–°æŒ‰é’®ä¸ºâ€œåœæ­¢â€çŠ¶æ€

                // ä½¿ç”¨ SetInterval è®©æ‰€æœ‰ç©ºçƒåŒæ—¶æ»šåŠ¨
                rollInterval = setInterval(() => {
                    if (availableNumbers.length === 0) {
                        clearInterval(rollInterval);
                        isRolling = false;
                        updateActionButton(drawnCount);
                        updateStatus("âš ï¸ å¥–æ± å·²ç©ºï¼ŒæŠ½å¥–ç»ˆæ­¢");
                        return;
                    }

                    rollingBalls.forEach(ball => {
                        // ä»å¯ç”¨å·ç ä¸­éšæœºé€‰æ‹©ä¸€ä¸ªæ˜¾ç¤º
                        const randomIndex = Math.floor(Math.random() * availableNumbers.length);
                        ball.textContent = availableNumbers[randomIndex];
                        ball.classList.add('rolling');
                    });
                }, 50); // æ…¢é€Ÿæ»šåŠ¨ï¼Œç»™ç”¨æˆ·åœæ­¢çš„æ—¶æœº

            } else {
                // --> 2. åœæ­¢æ»šåŠ¨å¹¶æ‰§è¡Œæ‰¹é‡æŠ½å–
                isRolling = false;
                clearInterval(rollInterval);

                // ç¡®å®šæœ¬æ¬¡å®é™…è¦æŠ½å–çš„æ•°é‡
                const drawCount = Math.min(remainingToDraw, availableNumbers.length);
                
                let newWinners = [];
                for (let i = 0; i < drawCount; i++) {
                    // éšæœºæŠ½å–å¹¶ä»å¯ç”¨æ± ä¸­ç§»é™¤
                    const winIndex = Math.floor(Math.random() * availableNumbers.length);
                    const winNum = availableNumbers[winIndex];
                    availableNumbers.splice(winIndex, 1); 
                    newWinners.push(winNum);
                }

                // æ›´æ–°ä¸­å¥–è®°å½•
                prizeRecords[currentPrizeId].push(...newWinners);
                saveData(); 

                // æ›´æ–° UI
                const emptyBalls = display.querySelectorAll('.ball:not(.won)');
                
                // ç¡®å®šåŠ¨ç”»æ—¶é—´å’Œç±»å
                const animationClass = `pulse-gold-${currentPrizeId}`;
                let duration = 500;
                if (currentPrizeId === '2nd') {
                    duration = 700;
                } else if (currentPrizeId === '1st') {
                    duration = 1000;
                }

                emptyBalls.forEach((ball, index) => {
                    if (index < drawCount) {
                        // ä»…æ›´æ–°å®é™…æŠ½ä¸­çš„çƒ
                        ball.textContent = newWinners[index];
                        ball.classList.remove('rolling');
                        ball.classList.add('won'); 
                        
                        // è§¦å‘ä¸­å¥–ç‰¹æ•ˆ
                        ball.classList.add('reveal', animationClass);
                        setTimeout(() => {
                            ball.classList.remove('reveal', animationClass);
                        }, duration); 
                        
                        // é‡æ–°è®¾ç½®é‡æŠ½äº‹ä»¶
                        ball.onclick = function() { redrawOne(this); };

                    } else {
                        // å¥–æ± ä¸è¶³å¯¼è‡´æœªæŠ½ä¸­ï¼Œè¿™äº›çƒæ¢å¤å ä½ç¬¦çŠ¶æ€
                        ball.textContent = '?';
                        ball.classList.remove('rolling');
                    }
                });
                
                // é‡æ–°æ¸²æŸ“å’Œæ›´æ–°çŠ¶æ€
                updateActionButton(drawnCount + drawCount);

                if (availableNumbers.length === 0 && drawCount > 0) {
                     updateStatus(`ğŸ‰ æˆåŠŸæŠ½å– ${drawCount} äººï¼âš ï¸ å¥–æ± å·²ç©ºï¼`);
                } else {
                     updateStatus(`ğŸ‰ æˆåŠŸæ‰¹é‡æŠ½å– ${drawCount} äººï¼`);
                }
            }
        }

        // --- å•ä¸ªé‡æŠ½é€»è¾‘ (å¤„ç†ç¼ºå¸­) ---
        function redrawOne(element) {
            if(isRolling) return;
            
            const oldNum = parseInt(element.textContent);
            // NOTE: Using window.confirm() as a functional placeholder for a custom modal UI in a simple tool.
            if(!window.confirm(`âš ï¸ ç¡®è®¤å·ç ã€${oldNum}ã€‘ç¼ºå¸­ï¼Ÿ\næˆ‘ä»¬å°†ä»å¥–æ± ä¸­é‡æ–°æŠ½å–ä¸€äººæ›¿æ¢ä»–ã€‚`)) return;

            if (availableNumbers.length === 0) {
                const status = document.getElementById('status-text');
                status.textContent = "âš ï¸ å¥–æ± å·²ç©ºï¼";
                setTimeout(() => updateStatus(), 1500);
                return;
            }

            const recordIndex = parseInt(element.id.split('-')[1]); 

            element.classList.add('rolling');
            element.classList.add('shaking');
            
            let singleRoll = setInterval(() => {
                const randomIndex = Math.floor(Math.random() * availableNumbers.length);
                element.textContent = availableNumbers[randomIndex];
            }, 50);

            setTimeout(() => {
                clearInterval(singleRoll);
                element.classList.remove('rolling');
                element.classList.remove('shaking');
                
                // æŠ½å–æ–°å·ç 
                const winIndex = Math.floor(Math.random() * availableNumbers.length);
                const winNum = availableNumbers[winIndex];
                availableNumbers.splice(winIndex, 1); 
                
                // å°†æ—§å·ç æ”¾å›å¥–æ± ï¼ˆé‡è¦ï¼Œå› ä¸ºæ˜¯é‡æŠ½ï¼‰
                availableNumbers.push(oldNum);

                // æ›´æ–°è®°å½•
                prizeRecords[currentPrizeId][recordIndex] = winNum;
                
                element.textContent = winNum;
                
                // é‡æŠ½ä¹Ÿåº”ç”¨ç‰¹æ•ˆ
                const animationClass = `pulse-gold-${currentPrizeId}`;
                element.classList.add('reveal', animationClass); 
                setTimeout(() => { element.classList.remove('reveal', animationClass); }, 500); // ä½¿ç”¨é»˜è®¤æ—¶é•¿

                saveData(); // ä¿å­˜é‡æŠ½åçš„ç»“æœ
                updateStatus(`æˆåŠŸé‡æŠ½ï¼æ—§å·ç  ${oldNum} å·²æ”¾å›å¥–æ± ã€‚`);
            }, 1000);
        }

        // --- å½»åº•æ¸…ç©ºç³»ç»Ÿæ•°æ® ---
        function resetAllData() {
            // ä¿æŒåŸæœ‰ window.confirm é€»è¾‘
            if(window.confirm("ğŸ”¥ğŸ”¥ è­¦å‘Šï¼šæ‚¨ç¡®å®šè¦å½»åº•æ¸…ç©ºæ‰€æœ‰ä¸­å¥–è®°å½•å’Œå¥–æ± æ•°æ®å—ï¼Ÿ\n\næ‚¨å°†éœ€è¦é‡æ–°å¼€å§‹ä» 600 äººä¸­æŠ½å–ä¸‰ç­‰å¥–ã€‚\n\nï¼ˆç¡®è®¤æ¸…ç©ºè¯·ç‚¹ ç¡®å®šï¼‰")) {
                localStorage.removeItem(LS_KEY_NUMBERS);
                localStorage.removeItem(LS_KEY_RECORDS);
                location.reload(); // åˆ·æ–°é¡µé¢ï¼Œé‡æ–°åˆå§‹åŒ–
            }
        }

        // --- çŠ¶æ€è¾…åŠ©å‡½æ•° ---
        function getLevelName(prizeId) {
            const names = {'1st': "ä¸€ç­‰å¥–", '2nd': "äºŒç­‰å¥–", '3rd': "ä¸‰ç­‰å¥–"};
            return names[prizeId] || "";
        }

        function updateStatus(prefix) {
            const text = prefix ? prefix : "å°±ç»ª";
            document.getElementById('status-text').textContent = `${text} | å‰©ä½™æœªä¸­å¥–äººæ•°ï¼š${availableNumbers.length}`;
        }
        
        // --- ç‰¹æ•ˆï¼šç²’å­ç³»ç»Ÿ (Confetti/Snow) ---
        const canvas = document.getElementById('particleCanvas');
        const ctx = canvas.getContext('2d');
        let particles = [];
        const particleCount = 50; 

        function resizeCanvas() {
            canvas.width = window.innerWidth;
            canvas.height = window.innerHeight;
        }
        window.addEventListener('resize', resizeCanvas);
        resizeCanvas();

        function Particle() {
            this.x = Math.random() * canvas.width;
            this.y = Math.random() * canvas.height;
            this.size = Math.random() * 3 + 1;
            this.speedX = Math.random() * 0.5 - 0.25; 
            this.speedY = Math.random() * 0.5 + 0.5;
            this.color = Math.random() < 0.5 ? 'rgba(255, 215, 0, 0.8)' : 'rgba(255, 0, 0, 0.8)';
        }

        Particle.prototype.draw = function() {
            ctx.fillStyle = this.color;
            ctx.beginPath();
            ctx.arc(this.x, this.y, this.size, 0, Math.PI * 2);
            ctx.fill();
        };

        Particle.prototype.update = function() {
            this.x += this.speedX;
            this.y += this.speedY;
            
            if (this.y > canvas.height) {
                this.y = 0;
                this.x = Math.random() * canvas.width;
            }
            if (this.x > canvas.width || this.x < 0) {
                 this.x = Math.random() * canvas.width;
            }
        };

        function initParticles() {
            particles = [];
            for (let i = 0; i < particleCount; i++) {
                particles.push(new Particle());
            }
        }
        initParticles();

        function animateParticles() {
            ctx.fillStyle = 'rgba(142, 14, 0, 0.05)'; 
            ctx.fillRect(0, 0, canvas.width, canvas.height);

            for (let i = 0; i < particles.length; i++) {
                particles[i].update();
                particles[i].draw();
            }
            requestAnimationFrame(animateParticles);
        }
        
        // æ³¨æ„ï¼šanimateParticlesåœ¨ loadData ä¸­è°ƒç”¨ï¼Œç¡®ä¿ canvas å·²ç»åˆå§‹åŒ–
    </script>
</body>
</html>